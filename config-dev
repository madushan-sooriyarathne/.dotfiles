#!/bin/bash

# config-dev - Development environment configuration script
# This script sets up dotfiles, symlinks, and installs development tools

set -e  # Exit on any error

echo "ğŸš€ Starting development environment configuration..."

# 1. Make all files in ~/.dotfiles/bin/ executable
echo "ğŸ“ Making all files in ~/.dotfiles/bin/ executable..."
if [ -d "$HOME/.dotfiles/bin" ]; then
    chmod +x "$HOME/.dotfiles/bin/"*
    echo "âœ… Made all files in ~/.dotfiles/bin/ executable"
else
    echo "âš ï¸  ~/.dotfiles/bin/ directory not found, skipping..."
fi

# 2. Create symlinks
echo "ğŸ”— Creating symlinks..."

# Function to create symlink safely
create_symlink() {
    local source="$1"
    local target="$2"
    
    if [ -e "$source" ]; then
        # Remove existing file/link if it exists
        if [ -e "$target" ] || [ -L "$target" ]; then
            echo "  Removing existing $target"
            rm -rf "$target"
        fi
        
        # Create the symlink
        ln -sf "$source" "$target"
        echo "  âœ… Created symlink: $target -> $source"
    else
        echo "  âš ï¸  Source file/directory $source not found, skipping..."
    fi
}

# Create all the required symlinks
create_symlink "$HOME/.dotfiles/.zshrc" "$HOME/.zshrc"
create_symlink "$HOME/.dotfiles/claude-config" "$HOME/.claude"
create_symlink "$HOME/.dotfiles/warp-config" "$HOME/.warp"
create_symlink "$HOME/.dotfiles/wezterm/wezterm.lua" "$HOME/.wezterm.lua"
create_symlink "$HOME/.dotfiles/.tmux.conf" "$HOME/.tmux.conf"

# 3. Install applications with brew
echo "ğŸº Installing applications with Homebrew..."

# Check if brew is installed
if ! command -v brew &> /dev/null; then
    echo "âŒ Homebrew not found. Please install Homebrew first:"
    echo "   /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
    exit 1
fi

# Install/upgrade Neovim first
echo "  Checking Neovim installation..."
if brew list "neovim" &>/dev/null; then
    echo "  ğŸ“¦ Neovim is installed, checking for updates..."
    brew upgrade neovim
    echo "  âœ… Neovim updated to latest version"
else
    echo "  ğŸ“¦ Installing Neovim..."
    brew install neovim
    echo "  âœ… Installed Neovim"
fi

# Install the required packages
packages=("stylua" "shfmt" "prettier")

for package in "${packages[@]}"; do
    echo "  Installing $package..."
    if brew list "$package" &>/dev/null; then
        echo "  âœ… $package is already installed"
    else
        brew install "$package"
        echo "  âœ… Installed $package"
    fi
done

# 4. Setup Neovim configuration
echo "âš™ï¸  Setting up Neovim configuration..."

nvim_config_dir="$HOME/.config/nvim"
nvim_repo_url="git@github.com:madushan-sooriyarathne/nvim-config.git"

# Create .config directory if it doesn't exist
mkdir -p "$HOME/.config"

if [ -d "$nvim_config_dir" ]; then
    echo "  ğŸ“ Neovim config directory exists, checking git status..."
    
    # Check if it's a git repository
    if [ -d "$nvim_config_dir/.git" ]; then
        cd "$nvim_config_dir"
        
        # Check if the remote origin matches our expected repo
        current_origin=$(git remote get-url origin 2>/dev/null || echo "")
        
        if [ "$current_origin" = "$nvim_repo_url" ]; then
            echo "  ğŸ” Correct git remote found, checking for updates..."
            
            # Fetch latest changes
            git fetch origin
            
            # Check if local main is behind remote main
            local_commit=$(git rev-parse HEAD)
            remote_commit=$(git rev-parse origin/main 2>/dev/null || git rev-parse origin/master 2>/dev/null)
            
            if [ "$local_commit" != "$remote_commit" ]; then
                echo "  ğŸ“¥ Local config is behind remote, pulling latest changes..."
                git pull origin main 2>/dev/null || git pull origin master 2>/dev/null
                echo "  âœ… Neovim config updated to latest version"
            else
                echo "  âœ… Neovim config is up to date"
            fi
        else
            echo "  âš ï¸  Different git remote found ($current_origin)"
            echo "  ğŸ”„ Backing up existing config and cloning fresh..."
            cd "$HOME/.config"
            mv nvim "nvim.backup.$(date +%Y%m%d_%H%M%S)"
            git clone "$nvim_repo_url" nvim
            echo "  âœ… Cloned fresh Neovim config (old config backed up)"
        fi
        
        cd "$HOME"  # Return to home directory
    else
        echo "  âš ï¸  Directory exists but is not a git repository"
        echo "  ğŸ”„ Backing up existing config and cloning fresh..."
        mv "$nvim_config_dir" "$nvim_config_dir.backup.$(date +%Y%m%d_%H%M%S)"
        git clone "$nvim_repo_url" "$nvim_config_dir"
        echo "  âœ… Cloned fresh Neovim config (old config backed up)"
    fi
else
    echo "  ğŸ“¥ Cloning Neovim configuration..."
    git clone "$nvim_repo_url" "$nvim_config_dir"
    echo "  âœ… Cloned Neovim config successfully"
fi

echo ""
echo "ğŸ‰ Development environment configuration completed successfully!"
echo ""
echo "ğŸ“ Summary of changes:"
echo "   â€¢ Made all files in ~/.dotfiles/bin/ executable"
echo "   â€¢ Created symlinks for dotfiles configuration"
echo "   â€¢ Installed/updated Neovim to latest version"
echo "   â€¢ Installed development tools: stylua, shfmt, prettier"
echo "   â€¢ Set up/updated Neovim configuration from git repository"
echo ""
echo "ğŸ’¡ You may need to restart your terminal or run 'source ~/.zshrc' for changes to take effect."
echo "ğŸ’¡ Run 'nvim' to start Neovim with your configuration."
